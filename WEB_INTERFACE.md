# 気象データ抽出システム - Web インターフェース v2.0

## 🌟 概要

MSMの気象データ（Lambert Conformal Conic投影、633×521格子、5km解像度）から指定した地点・範囲・時間のデータを抽出し、リアルタイムでグラフ表示するWebアプリケーションです。

## 🚀 新機能・改善点（v2.0）

### ✨ 新機能
- **リアルタイムグラフ描画**: JSON抽出結果を自動的に時系列グラフで可視化
- **MSM格子点表示**: 633×521格子点の地図上での可視化
- **使用格子点ハイライト**: データ抽出に使用した格子点を赤色で強調表示
- **格子表示密度制御**: ズームレベルに応じた自動密度調整（5km〜40km間隔）
- **平均化距離計算修正**: KDTreeの座標系統一による正確な距離計算

### 🛠️ 改善点
- **UI簡素化**: 不要な「格子範囲表示」機能を削除
- **エラーハンドリング強化**: より詳細なエラーメッセージとデバッグ情報
- **パフォーマンス向上**: 格子点表示の最適化
- **レスポンシブ対応**: モバイル・タブレット環境での操作性向上

## 🌐 アクセス方法

### 1. アプリケーション起動
```bash
cd /Users/ishizu/Desktop/Local_Analysis
python3 app_optimized.py
```

### 2. ブラウザアクセス
```
http://localhost:8000
```

## 🗺️ マップ機能

### インタラクティブマップ
- **Leaflet.js**ベースの高性能Webマップ
- OpenStreetMapタイル使用
- 日本域中心（35°N, 139°E）の初期表示

### 格子点可視化システム
#### MSM格子点表示
- **総格子数**: 633×521 = 329,793点
- **解像度**: 5km間隔
- **投影法**: Lambert Conformal Conic
- **表示色**: 青色ドット

#### 密度制御機能
- **自動調整**: ズームレベルに応じた表示間隔の動的変更
- **手動設定**: 
  - 最高密度（5km間隔、全格子点）
  - 高密度（10km間隔）
  - 中密度（20km間隔）
  - 低密度（40km間隔）

#### 使用格子点ハイライト
- **赤色表示**: データ抽出に実際に使用した格子点
- **リアルタイム更新**: 抽出実行後に自動で表示
- **情報表示**: ポップアップで格子座標と地理座標を表示

### 地点選択機能
- **クリック選択**: マップ上をクリックして緯度・経度を自動入力
- **マーカー表示**: 選択地点に青色マーカーを配置
- **座標表示**: 選択地点の緯度・経度をリアルタイム表示

## 🎛️ データ抽出制御

### 抽出方法
#### 最近傍法
- 選択地点に最も近い1格子点のデータを取得
- 高速処理、単点データ取得に最適

#### 平均化法
- **半径指定**: 指定したkm範囲内の全格子点を平均
- **k近傍指定**: 最も近いk個の格子点を平均
- **距離計算**: Lambert Conformal Conic投影での正確な距離計算

### データタイプ選択
#### 地表面データ
- 地上気温（1.5m高度）
- 相対湿度（1.5m高度） 
- 風速U/V成分（10m高度）
- 海面更正気圧

#### 等圧面データ
- 気温・相対湿度・風速U/V成分
- ジオポテンシャル高度
- 利用可能レベル: 1000〜100 hPa

### 時間選択機能
#### 単一時刻モード
- 指定した1時刻のデータを抽出
- リアルタイム処理

#### 時間範囲モード
- 開始〜終了時刻の期間データを一括抽出
- 時系列グラフ表示に最適

**重要**: 全ての時刻はJST（日本標準時）で指定

### 出力形式
#### JSON形式（推奨）
- **ブラウザ表示**: テーブル形式での詳細表示
- **自動グラフ生成**: 時系列データの折れ線グラフ
- **インタラクティブ**: グラフの拡大・縮小・データポイント確認

#### CSV形式
- **ファイルダウンロード**: 直接CSVファイルとして保存
- **外部解析**: Excel・R・Pythonでの後処理に最適

## 📊 可視化機能

### 時系列グラフシステム
#### 自動グラフ生成
- **条件**: JSON形式での抽出結果表示時
- **対象**: 時刻カラムを含む数値データ
- **グラフタイプ**: 全て折れ線グラフ

#### マルチグラフ表示
- **個別グラフ**: 各気象要素ごとに独立したグラフ
- **グリッドレイアウト**: 2列配置でコンパクト表示
- **カラーコーディング**: 各変数に固有の色を割り当て

#### 日本語対応
- **グラフタイトル**: 「気温 (°C)」「風速 (m/s)」など
- **軸ラベル**: X軸「時刻」、Y軸「変数名+単位」
- **時刻フォーマット**: 「MM/DD HH:MM」形式

#### 対応変数
- U成分 (m/s) / V成分 (m/s)
- 気温 (°C) / 地上気温 (°C)
- 相対湿度 (%)
- 海面更正気圧 (hPa) / 気圧 (hPa)
- 風速 (m/s) / 風向 (度)

### テーブル表示
#### データ詳細表示
- **スクロール対応**: 大量データの効率的表示
- **日本語ヘッダー**: 理解しやすい列名
- **数値フォーマット**: 適切な小数点桁数での表示
- **時刻変換**: ISO8601からローカル時刻への自動変換

#### 統計情報
- **データ件数**: 抽出されたレコード数
- **カラム数**: データの項目数
- **処理格子点数**: 使用した格子点の総数

## 🔧 技術仕様

### フロントエンド技術
#### 地図表示
- **Leaflet.js 1.7.1**: 軽量高性能マップライブラリ
- **OpenStreetMap**: オープンソースタイルマップ
- **カスタムマーカー**: 地点選択・格子点表示用

#### グラフ描画
- **Chart.js**: レスポンシブ対応のグラフライブラリ
- **Canvas描画**: 高性能なリアルタイム描画
- **インタラクション**: ホバー・ズーム・パン対応

#### UI フレームワーク
- **Bootstrap 5**: モダンなレスポンシブデザイン
- **CSS Grid/Flexbox**: 効率的なレイアウト管理
- **JavaScript ES6**: モダンなイベント処理

### バックエンド技術
#### Webフレームワーク
- **Flask**: 軽量Pythonウェブフレームワーク
- **RESTful API**: JSON形式でのデータ交換
- **エラーハンドリング**: 詳細なHTTPステータスコード

#### データ処理エンジン
- **xarray**: NetCDF4ファイルの効率的読み込み
- **pandas**: データフレーム操作・変換
- **scipy.spatial.cKDTree**: 高速最近傍検索
- **numpy**: 数値計算・配列操作

#### 投影・座標系
- **pyproj**: Lambert Conformal Conic投影変換
- **投影パラメータ**:
  - 標準緯線: 30°N, 60°N
  - 中央経線: 140°E
  - 基準点: (140°E, 30°N) = 格子[360, 448]

## � API エンドポイント

### データ抽出API
#### POST /api/extract
```json
{
  "lat": 35.6762,
  "lon": 139.6503,
  "dataType": "surface|isobaric",
  "variables": ["t", "wind_speed", "wind_direction"],
  "levels": [1000, 850, 500],
  "method": "nearest|mean",
  "radiusKm": 15.0,
  "kNeighbors": 5,
  "timeMode": "single|range",
  "timeSingle": "2024-07-03T12:00",
  "timeStart": "2024-07-03T09:00",
  "timeEnd": "2024-07-03T15:00",
  "outputFormat": "json|csv"
}
```

### 情報取得API
#### GET /api/available_variables
利用可能な気象変数の詳細情報
```json
{
  "surface": {
    "t": {"name": "地上気温", "unit": "°C", "description": "1.5m高度での気温"},
    "rh": {"name": "相対湿度", "unit": "%", "description": "1.5m高度での相対湿度"},
    "u": {"name": "風速U成分", "unit": "m/s", "description": "10m高度での東西風成分"},
    "v": {"name": "風速V成分", "unit": "m/s", "description": "10m高度での南北風成分"},
    "pres": {"name": "海面更正気圧", "unit": "hPa", "description": "海面高度に換算した気圧"}
  },
  "isobaric": {
    "t": {"name": "気温", "unit": "°C", "description": "等圧面での気温"},
    "rh": {"name": "相対湿度", "unit": "%", "description": "等圧面での相対湿度"},
    "u": {"name": "風速U成分", "unit": "m/s", "description": "等圧面での東西風成分"},
    "v": {"name": "風速V成分", "unit": "m/s", "description": "等圧面での南北風成分"},
    "z": {"name": "ジオポテンシャル高度", "unit": "gpm", "description": "等圧面の高度"}
  }
}
```

#### GET /api/available_levels
利用可能な等圧面レベル
```json
{
  "levels": [1000, 975, 950, 925, 900, 850, 800, 750, 700, 650, 600, 550, 500, 450, 400, 350, 300, 250, 200, 150, 100]
}
```

### 格子点情報API
#### GET /api/grid_points?step=10
格子点情報（密度制御付き）
```json
{
  "status": "success",
  "total_points": 329793,
  "returned_points": 3392,
  "step": 10,
  "points": [
    {"lat": 45.0, "lon": 120.0, "grid_y": 0, "grid_x": 0},
    {"lat": 45.0, "lon": 120.1, "grid_y": 0, "grid_x": 10}
  ]
}
```

#### GET /api/all_grid_points?format=full
全格子点情報（可視化用）
```json
{
  "status": "success", 
  "total_points": 329793,
  "coordinates": [[lat1,lon1], [lat2,lon2], ...]
}
```

#### GET /api/nearby_grid_points
近傍格子点検索
```json
{
  "lat": 35.6762,
  "lon": 139.6503,
  "radius": 50,
  "max_points": 50,
  "points": [
    {"lat": 35.67, "lon": 139.65, "distance_km": 2.1, "grid_y": 360, "grid_x": 448}
  ]
}
```

## � 使用方法・操作ガイド

### 基本操作フロー
1. **地点選択**: マップ上をクリックして抽出地点を選択
2. **格子点表示**: 「全格子点を表示」をチェックして周辺格子を確認
3. **データ設定**: データタイプ・変数・時間範囲を選択
4. **抽出方法設定**: 最近傍 or 平均化（半径/k近傍）を選択
5. **実行**: 「データ抽出実行」ボタンをクリック
6. **結果確認**: テーブル表示とグラフで結果を確認

### 高度な使用例

#### 台風解析
```
1. 台風中心付近をマップで選択
2. データタイプ: 地表面
3. 変数: 風速U成分、風速V成分、気圧
4. 時間範囲: 台風通過期間を設定
5. 抽出方法: 半径20km平均化
6. 結果: 時系列グラフで風向・風速変化を確認
```

#### 高層天気図作成用データ
```
1. 観測地点をマップで選択
2. データタイプ: 等圧面
3. レベル: 1000, 850, 700, 500, 300 hPa
4. 変数: 気温、湿度、風速、高度
5. 時間: 特定時刻（例：12UTC）
6. 抽出方法: 最近傍
```

## 🎯 パフォーマンス・最適化

### 表示最適化
- **格子点表示**: ズームレベルに応じた自動間引き
- **メモリ効率**: 必要な範囲のみデータロード
- **キャッシュ**: 格子点座標の効率的管理

### 計算最適化
- **KDTree**: 高速最近傍検索
- **ベクトル化**: numpyによる高速数値計算
- **並列処理**: 複数変数の同時処理

### ネットワーク最適化
- **JSON圧縮**: gzip圧縮によるデータ転送効率化
- **非同期通信**: AJAX による UI ブロック防止
- **エラー回復**: 通信エラー時の自動リトライ

## ⚠️ 注意事項・制限事項

### データに関する注意
1. **時刻**: 全てJST（UTC+9）で処理
2. **ファイル**: 破損ファイル（<1MB）は自動除外
3. **範囲**: MSM領域外の座標は処理不可
4. **時間範囲**: 過度に長い期間は処理時間増大

### システム制限
1. **メモリ**: 大量データ処理時は8GB以上推奨
2. **ブラウザ**: Chrome/Firefox/Safari最新版
3. **ネットワーク**: ローカル環境での動作想定
4. **同時処理**: 単一ユーザーでの設計

### トラブルシューティング
#### よくあるエラー
- **"格子点が見つかりません"**: 座標がMSM領域外
- **"データが見つかりませんでした"**: 指定時刻のファイルが存在しない  
- **"グラフが表示されない"**: JSON形式以外が選択されている
- **"処理が遅い"**: 格子点表示を無効化して処理負荷を軽減

#### デバッグ方法
```javascript
// ブラウザ開発者ツールのコンソールで
console.log('抽出データ:', extractedData);
console.log('格子点情報:', gridPoints);
```

## 🚀 今後の開発予定

### v2.1 予定機能
- **等値線表示**: 気温・気圧の等値線描画
- **ベクトル表示**: 風向・風速のベクトル矢印
- **アニメーション**: 時系列データの動画表示
- **統計解析**: 平均・標準偏差・傾向分析

### v3.0 構想
- **マルチユーザー対応**: セッション管理・ユーザー認証
- **データベース連携**: PostgreSQL/PostGISとの統合
- **API拡張**: REST APIの機能拡張
- **機械学習**: 異常値検出・予測機能

---

## 📋 まとめ

この気象データ抽出システムv2.0では、MSMデータの持つ高解像度・高精度な情報を最大限活用できる環境を提供しています。WebインターフェースとリアルタイムGraphs機能により、研究・業務・教育の様々な場面で効率的な気象データ解析が可能になりました。

**主な利点**:
- 直感的なマップ操作による地点選択
- リアルタイムグラフでの即座な結果確認  
- 正確な格子点座標系での精密な距離計算
- 豊富な出力形式による後処理の柔軟性