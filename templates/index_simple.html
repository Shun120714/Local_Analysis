<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°—è±¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <style>
        #map {
            height: 500px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .coordinate-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .loading {
            display: none;
        }
        
        .results-table {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .level-checkbox {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        
        .extraction-status {
            margin-top: 15px;
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">æ°—è±¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- ãƒãƒƒãƒ—éƒ¨åˆ† -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">åœ°ç‚¹é¸æŠ</h5>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                        <div class="coordinate-display">
                            <strong>é¸æŠåœ°ç‚¹:</strong>
                            <div id="coordinates">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">æŠ½å‡ºè¨­å®š</h5>
                    </div>
                    <div class="card-body">
                        <!-- æ ¼å­ç‚¹è¡¨ç¤ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                        <div class="mb-3">
                            <label class="form-label">åœ°å›³è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showGridPoints">
                                <label class="form-check-label" for="showGridPoints">
                                    å…¨æ ¼å­ç‚¹ã‚’è¡¨ç¤º (633Ã—521)
                                </label>
                            </div>
                            <div class="mt-2" id="gridDensityOptions" style="display: none;">
                                <label class="form-label small" for="gridDensity">è¡¨ç¤ºå¯†åº¦</label>
                                <select class="form-select form-select-sm" id="gridDensity" name="gridDensity">
                                    <option value="auto">è‡ªå‹•ï¼ˆã‚ºãƒ¼ãƒ é€£å‹•ï¼‰</option>
                                    <option value="1">æœ€é«˜å¯†åº¦ï¼ˆ5kmé–“éš”ï¼‰</option>
                                    <option value="2">é«˜å¯†åº¦ï¼ˆ10kmé–“éš”ï¼‰</option>
                                    <option value="4">ä¸­å¯†åº¦ï¼ˆ20kmé–“éš”ï¼‰</option>
                                    <option value="8">ä½å¯†åº¦ï¼ˆ40kmé–“éš”ï¼‰</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showNearbyGridPoints">
                                <label class="form-check-label" for="showNearbyGridPoints">é¸æŠç‚¹ä»˜è¿‘ã®æ ¼å­ç‚¹ã®ã¿è¡¨ç¤º</label>
                            </div>
                            <div class="mt-2" id="nearbyGridOptions" style="display: none;">
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">åŠå¾„ (km)</label>
                                        <input type="number" class="form-control form-control-sm" id="nearbyRadius" value="50" min="10" max="200" step="10">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">æœ€å¤§è¡¨ç¤ºç‚¹æ•°</label>
                                        <input type="number" class="form-control form-control-sm" id="nearbyMaxPoints" value="50" min="10" max="200" step="10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—é¸æŠ -->
                        <div class="mb-3">
                            <label class="form-label">ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dataType" value="surface" id="surfaceData" checked>
                                    <label class="form-check-label" for="surfaceData">åœ°ä¸Šãƒ‡ãƒ¼ã‚¿</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dataType" value="isobaric" id="isobaricData">
                                    <label class="form-check-label" for="isobaricData">æ°—åœ§é¢ãƒ‡ãƒ¼ã‚¿</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ°—åœ§é¢ãƒ¬ãƒ™ãƒ«é¸æŠ -->
                        <div class="mb-3" id="levelSelection" style="display: none;">
                            <label class="form-label">æ°—åœ§é¢ãƒ¬ãƒ™ãƒ« (hPa)</label>
                            <div id="levelCheckboxes" class="border p-2" style="max-height: 200px; overflow-y: auto;">
                                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                        
                        <!-- å¤‰æ•°é¸æŠ -->
                        <div class="mb-3">
                            <label class="form-label">å–å¾—å¤‰æ•°</label>
                            <div id="variableSelection" style="max-height: 200px; overflow-y: auto;">
                                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                        
                        <!-- æŠ½å‡ºæ–¹æ³• -->
                        <div class="mb-3">
                            <label class="form-label">æŠ½å‡ºæ–¹æ³•</label>
                            <select class="form-select" id="method">
                                <option value="nearest">æœ€è¿‘å‚ç‚¹</option>
                                <option value="mean">å¹³å‡åŒ–</option>
                            </select>
                        </div>
                        
                        <!-- å¹³å‡åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div class="mb-3" id="meanOptions" style="display: none;">
                            <label class="form-label">å¹³å‡åŒ–ç¯„å›²</label>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label small">åŠå¾„ (km)</label>
                                    <input type="number" class="form-control form-control-sm" id="radiusKm" value="10" min="1" max="100">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small">ã¾ãŸã¯è¿‘å‚ç‚¹æ•°</label>
                                    <input type="number" class="form-control form-control-sm" id="kNeighbors" min="1" max="50">
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ™‚é–“ãƒ¢ãƒ¼ãƒ‰ -->
                        <div class="mb-3">
                            <label class="form-label">æ™‚é–“é¸æŠ</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeMode" value="single" id="singleTime" checked>
                                    <label class="form-check-label" for="singleTime">å˜ä¸€æ™‚åˆ»</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeMode" value="range" id="rangeTime">
                                    <label class="form-check-label" for="rangeTime">æ™‚é–“ç¯„å›²</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ™‚é–“å…¥åŠ› -->
                        <div class="mb-3" id="singleTimeInput">
                            <label class="form-label">æ™‚åˆ» (JST)</label>
                            <input type="datetime-local" class="form-control" id="timeSingle" value="2024-07-03T12:00">
                        </div>
                        
                        <div class="mb-3" id="rangeTimeInput" style="display: none;">
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">é–‹å§‹æ™‚åˆ» (JST)</label>
                                    <input type="datetime-local" class="form-control" id="timeStart" value="2024-07-03T00:00">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">çµ‚äº†æ™‚åˆ» (JST)</label>
                                    <input type="datetime-local" class="form-control" id="timeEnd" value="2024-07-03T23:00">
                                </div>
                            </div>
                        </div>
                        
                        <!-- å‡ºåŠ›å½¢å¼ -->
                        <div class="mb-3">
                            <label class="form-label">å‡ºåŠ›å½¢å¼</label>
                            <select class="form-select" id="outputFormat">
                                <option value="json">JSONï¼ˆç”»é¢è¡¨ç¤ºï¼‰</option>
                                <option value="csv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</option>
                            </select>
                        </div>
                        
                        <!-- æŠ½å‡ºãƒœã‚¿ãƒ³ -->
                        <button type="button" class="btn btn-primary w-100" id="extractBtn">ãƒ‡ãƒ¼ã‚¿æŠ½å‡º</button>
                        
                        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                        <div class="loading text-center mt-3" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">æŠ½å‡ºä¸­...</span>
                            </div>
                            <div>ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™...</div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                        <div id="status" class="extraction-status" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çµæœè¡¨ç¤º -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">æŠ½å‡ºçµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="results">
                            æŠ½å‡ºã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                        </div>
                        <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div id="charts-container" style="display: none;">
                            <hr>
                            <h6>æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•</h6>
                            <div id="charts" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let marker;
        let selectedLat = null;
        let selectedLon = null;
        let gridPointsLayer = null;
        let usedGridPointsLayer = null;
        
        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        function initMap() {
            // æ—¥æœ¬ä¸­å¿ƒã®åˆæœŸè¡¨ç¤º
            map = L.map('map').setView([35.0, 139.0], 6);
            
            // OpenStreetMapã‚¿ã‚¤ãƒ«
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // æ ¼å­ç‚¹è¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('showGridPoints').addEventListener('change', function(e) {
                if (e.target.checked) {
                    showGridPoints();
                } else {
                    hideGridPoints();
                }
            });
            
            // ä»˜è¿‘æ ¼å­ç‚¹è¡¨ç¤ºãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('showNearbyGridPoints').addEventListener('change', function(e) {
                const optionsDiv = document.getElementById('nearbyGridOptions');
                if (e.target.checked) {
                    optionsDiv.style.display = 'block';
                    // å…¨ä½“è¡¨ç¤ºã‚’ã‚ªãƒ•ã«ã™ã‚‹
                    document.getElementById('showGridPoints').checked = false;
                    hideGridPoints();
                    // é¸æŠç‚¹ãŒã‚ã‚Œã°ä»˜è¿‘æ ¼å­ç‚¹ã‚’è¡¨ç¤º
                    if (selectedLat !== null && selectedLon !== null) {
                        showNearbyGridPoints();
                    }
                } else {
                    optionsDiv.style.display = 'none';
                    hideGridPoints();
                }
            });
            
            // ä»˜è¿‘æ ¼å­ç‚¹è¨­å®šå¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('nearbyRadius').addEventListener('change', function() {
                if (document.getElementById('showNearbyGridPoints').checked && 
                    selectedLat !== null && selectedLon !== null) {
                    showNearbyGridPoints();
                }
            });
            
            document.getElementById('nearbyMaxPoints').addEventListener('change', function() {
                if (document.getElementById('showNearbyGridPoints').checked && 
                    selectedLat !== null && selectedLon !== null) {
                    showNearbyGridPoints();
                }
            });
            
            // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            map.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLon = e.latlng.lng;
                
                // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([selectedLat, selectedLon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                
                // åº§æ¨™è¡¨ç¤ºæ›´æ–°
                document.getElementById('coordinates').innerHTML = 
                    `ç·¯åº¦: ${selectedLat.toFixed(4)}Â°<br>çµŒåº¦: ${selectedLon.toFixed(4)}Â°`;
                
                // ä»˜è¿‘æ ¼å­ç‚¹è¡¨ç¤ºãŒæœ‰åŠ¹ãªå ´åˆã¯æ›´æ–°
                if (document.getElementById('showNearbyGridPoints').checked) {
                    showNearbyGridPoints();
                }
            });
        }
        
        // æ ¼å­ç‚¹è¡¨ç¤º
        function showGridPoints() {
            if (gridPointsLayer) {
                return; // æ—¢ã«è¡¨ç¤ºä¸­
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'grid-loading';
            loadingDiv.innerHTML = '<div class="alert alert-info">æ ¼å­ç‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            document.body.appendChild(loadingDiv);
            
            fetch('/api/grid_points?step=10') // 10ç‚¹ãŠãã«è¡¨ç¤º
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        gridPointsLayer = L.layerGroup();
                        
                        data.points.forEach(point => {
                            const circle = L.circleMarker([point.lat, point.lon], {
                                radius: 2,
                                color: 'blue',
                                fillColor: 'lightblue',
                                fillOpacity: 0.6,
                                weight: 1
                            }).bindPopup(`æ ¼å­ç‚¹<br>ç·¯åº¦: ${point.lat.toFixed(3)}Â°<br>çµŒåº¦: ${point.lon.toFixed(3)}Â°`);
                            
                            gridPointsLayer.addLayer(circle);
                        });
                        
                        gridPointsLayer.addTo(map);
                    } else {
                        alert('æ ¼å­ç‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ ¼å­ç‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                })
                .finally(() => {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                    const loadingDiv = document.getElementById('grid-loading');
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
                });
        }
        
        // æ ¼å­ç‚¹éè¡¨ç¤º
        function hideGridPoints() {
            if (gridPointsLayer) {
                map.removeLayer(gridPointsLayer);
                gridPointsLayer = null;
            }
            // ä½¿ç”¨æ ¼å­ç‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¿æŒï¼ˆãƒ‡ãƒ¼ã‚¿æŠ½å‡ºçµæœã¨ã—ã¦é‡è¦ï¼‰
        }
        
        // ä»˜è¿‘æ ¼å­ç‚¹è¡¨ç¤º
        function showNearbyGridPoints() {
            if (!selectedLat || !selectedLon) {
                alert('ã¾ãšåœ°å›³ä¸Šã§ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ—¢å­˜ã®æ ¼å­ç‚¹ã‚’å‰Šé™¤
            hideGridPoints();
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
            const radius = parseInt(document.getElementById('nearbyRadius').value) || 50;
            const maxPoints = parseInt(document.getElementById('nearbyMaxPoints').value) || 50;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'grid-loading';
            loadingDiv.innerHTML = '<div class="alert alert-info">ä»˜è¿‘ã®æ ¼å­ç‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            document.body.appendChild(loadingDiv);
            
            // APIã‹ã‚‰ä»˜è¿‘æ ¼å­ç‚¹ã‚’å–å¾—
            fetch(`/api/nearby_grid_points?lat=${selectedLat}&lon=${selectedLon}&radius=${radius}&max_points=${maxPoints}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        gridPointsLayer = L.layerGroup();
                        
                        data.points.forEach((point, index) => {
                            // è·é›¢ã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹
                            const distance = point.distance || 0;
                            let color = 'blue';
                            let fillColor = 'lightblue';
                            
                            if (distance < radius * 0.3) {
                                color = 'red';
                                fillColor = 'lightcoral';
                            } else if (distance < radius * 0.6) {
                                color = 'orange';
                                fillColor = 'lightyellow';
                            }
                            
                            const circle = L.circleMarker([point.lat, point.lon], {
                                radius: 4,
                                color: color,
                                fillColor: fillColor,
                                fillOpacity: 0.7,
                                weight: 1
                            }).bindPopup(`
                                æ ¼å­ç‚¹ #${index + 1}<br>
                                ç·¯åº¦: ${point.lat.toFixed(4)}Â°<br>
                                çµŒåº¦: ${point.lon.toFixed(4)}Â°<br>
                                è·é›¢: ${distance.toFixed(1)} km<br>
                                ã‚°ãƒªãƒƒãƒ‰: [${point.grid_i}, ${point.grid_j}]
                            `);
                            
                            gridPointsLayer.addLayer(circle);
                        });
                        
                        gridPointsLayer.addTo(map);
                        
                        // æƒ…å ±ã‚’æ›´æ–°
                        const infoText = `ä»˜è¿‘æ ¼å­ç‚¹: ${data.points.length}ç‚¹è¡¨ç¤º (åŠå¾„${radius}kmå†…)`;
                        const existingInfo = document.getElementById('grid-info');
                        if (existingInfo) {
                            existingInfo.textContent = infoText;
                        } else {
                            const infoDiv = document.createElement('div');
                            infoDiv.id = 'grid-info';
                            infoDiv.className = 'alert alert-success mt-2';
                            infoDiv.textContent = infoText;
                            document.getElementById('coordinates').parentNode.appendChild(infoDiv);
                        }
                        
                    } else {
                        alert('ä»˜è¿‘æ ¼å­ç‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä»˜è¿‘æ ¼å­ç‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                })
                .finally(() => {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                    const loadingDiv = document.getElementById('grid-loading');
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
                });
        }
        
        // æ°—åœ§é¢ãƒ¬ãƒ™ãƒ«åˆæœŸåŒ–
        function initLevels() {
            fetch('/api/available_levels')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const container = document.getElementById('levelCheckboxes');
                        container.innerHTML = '';
                        
                        data.levels.forEach(level => {
                            const div = document.createElement('div');
                            div.className = 'form-check level-checkbox';
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" value="${level}" id="level${level}">
                                <label class="form-check-label" for="level${level}">
                                    ${level} hPa
                                </label>
                            `;
                            container.appendChild(div);
                        });
                        
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¸»è¦ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ
                        [1000, 850, 500, 300].forEach(level => {
                            const checkbox = document.getElementById(`level${level}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    } else {
                        console.error('ãƒ¬ãƒ™ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', data.message);
                    }
                })
                .catch(error => {
                    console.error('ãƒ¬ãƒ™ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // å¤‰æ•°é¸æŠã®èª­ã¿è¾¼ã¿
        function loadVariables() {
            fetch('/api/available_variables')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.allVariables = data.variables;
                        updateVariableSelection();
                    } else {
                        console.error('å¤‰æ•°ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', data.message);
                    }
                })
                .catch(error => {
                    console.error('å¤‰æ•°ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        
        // å¤‰æ•°é¸æŠUIã‚’æ›´æ–°
        function updateVariableSelection() {
            const container = document.getElementById('variableSelection');
            container.innerHTML = '';
            
            if (!window.allVariables) return;
            
            // å¤‰æ•°ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã—ã¦è¡¨ç¤º
            const basicVars = window.allVariables.filter(v => ['u', 'v', 't', 'rh', 'pressure'].includes(v.name));
            const windVars = window.allVariables.filter(v => ['wind_speed', 'wind_direction'].includes(v.name));
            const otherVars = window.allVariables.filter(v => !['u', 'v', 't', 'rh', 'pressure', 'wind_speed', 'wind_direction'].includes(v.name));
            
            // åŸºæœ¬å¤‰æ•°
            if (basicVars.length > 0) {
                const basicSection = document.createElement('div');
                basicSection.innerHTML = '<h6 class="text-primary mb-2">ğŸŒ¡ï¸ åŸºæœ¬å¤‰æ•°</h6>';
                container.appendChild(basicSection);
                
                basicVars.forEach(variable => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§U, Væˆåˆ†ã‚’ãƒã‚§ãƒƒã‚¯
                    const isChecked = ['u', 'v'].includes(variable.name) ? 'checked' : '';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${variable.name}" id="var_${variable.name}" ${isChecked}>
                        <label class="form-check-label" for="var_${variable.name}">
                            <strong>${variable.long_name}</strong> 
                            <small class="text-muted">(${variable.units})</small>
                            <br><small class="text-secondary">${variable.description || ''}</small>
                        </label>
                    `;
                    container.appendChild(div);
                });
            }
            
            // é¢¨é–¢é€£å¤‰æ•°
            if (windVars.length > 0) {
                const windSection = document.createElement('div');
                windSection.className = 'mt-3';
                windSection.innerHTML = '<h6 class="text-success mb-2">ğŸ’¨ é¢¨é–¢é€£ï¼ˆè¨ˆç®—å€¤ï¼‰</h6>';
                container.appendChild(windSection);
                
                windVars.forEach(variable => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¢¨é€Ÿãƒ»é¢¨å‘ã‚’ãƒã‚§ãƒƒã‚¯
                    const isChecked = 'checked';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${variable.name}" id="var_${variable.name}" ${isChecked}>
                        <label class="form-check-label" for="var_${variable.name}">
                            <strong>${variable.long_name}</strong> 
                            <small class="text-muted">(${variable.units})</small>
                            <br><small class="text-secondary">${variable.description || ''}</small>
                        </label>
                    `;
                    container.appendChild(div);
                });
            }
            
            // ãã®ä»–ã®å¤‰æ•°
            if (otherVars.length > 0) {
                const otherSection = document.createElement('div');
                otherSection.className = 'mt-3';
                otherSection.innerHTML = '<h6 class="text-secondary mb-2">ğŸ“Š ãã®ä»–</h6>';
                container.appendChild(otherSection);
                
                otherVars.forEach(variable => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${variable.name}" id="var_${variable.name}">
                        <label class="form-check-label" for="var_${variable.name}">
                            <strong>${variable.long_name}</strong> 
                            <small class="text-muted">(${variable.units})</small>
                            <br><small class="text-secondary">${variable.description || ''}</small>
                        </label>
                    `;
                    container.appendChild(div);
                });
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—å¤‰æ›´
            document.querySelectorAll('input[name="dataType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const levelSelection = document.getElementById('levelSelection');
                    if (this.value === 'isobaric') {
                        levelSelection.style.display = 'block';
                    } else {
                        levelSelection.style.display = 'none';
                    }
                });
            });
            
            // æŠ½å‡ºæ–¹æ³•å¤‰æ›´
            document.getElementById('method').addEventListener('change', function() {
                const meanOptions = document.getElementById('meanOptions');
                if (this.value === 'mean') {
                    meanOptions.style.display = 'block';
                } else {
                    meanOptions.style.display = 'none';
                }
            });
            
            // æ™‚é–“ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
            document.querySelectorAll('input[name="timeMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const singleInput = document.getElementById('singleTimeInput');
                    const rangeInput = document.getElementById('rangeTimeInput');
                    
                    if (this.value === 'single') {
                        singleInput.style.display = 'block';
                        rangeInput.style.display = 'none';
                    } else {
                        singleInput.style.display = 'none';
                        rangeInput.style.display = 'block';
                    }
                });
            });
            
            // å‡ºåŠ›å½¢å¼å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('outputFormat').addEventListener('change', function() {
                // JSONä»¥å¤–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯ã‚°ãƒ©ãƒ•ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                if (this.value !== 'json') {
                    const chartsContainer = document.getElementById('charts-container');
                    chartsContainer.style.display = 'none';
                    
                    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                    currentCharts.forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    currentCharts = [];
                }
            });
            
            // æŠ½å‡ºãƒœã‚¿ãƒ³
            document.getElementById('extractBtn').addEventListener('click', function() {
                if (selectedLat === null || selectedLon === null) {
                    alert('åœ°å›³ä¸Šã§åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                extractData();
            });
        }
        
        // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Ÿè¡Œ
        function extractData() {
            showLoading(true);
            showStatus('info', 'ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™...');
            
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åé›†
            const dataType = document.querySelector('input[name="dataType"]:checked').value;
            const method = document.getElementById('method').value;
            const timeMode = document.querySelector('input[name="timeMode"]:checked').value;
            const outputFormat = document.getElementById('outputFormat').value;
            
            // é¸æŠã•ã‚ŒãŸå¤‰æ•°
            const variables = Array.from(document.querySelectorAll('#variableSelection input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (variables.length === 0) {
                showLoading(false);
                showStatus('error', 'å°‘ãªãã¨ã‚‚1ã¤ã®å¤‰æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // æ™‚é–“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            let timeParams = {};
            if (timeMode === 'single') {
                timeParams.timeSingle = document.getElementById('timeSingle').value;
            } else {
                timeParams.timeStart = document.getElementById('timeStart').value;
                timeParams.timeEnd = document.getElementById('timeEnd').value;
            }
            
            // æ°—åœ§é¢ãƒ¬ãƒ™ãƒ«
            let levels = [];
            if (dataType === 'isobaric') {
                levels = Array.from(document.querySelectorAll('#levelCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                if (levels.length === 0) {
                    showLoading(false);
                    showStatus('error', 'å°‘ãªãã¨ã‚‚1ã¤ã®æ°—åœ§é¢ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
            }
            
            // å¹³å‡åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            let meanParams = {};
            if (method === 'mean') {
                const radiusKm = document.getElementById('radiusKm').value;
                const kNeighbors = document.getElementById('kNeighbors').value;
                
                if (radiusKm) {
                    meanParams.radiusKm = parseFloat(radiusKm);
                }
                if (kNeighbors) {
                    meanParams.kNeighbors = parseInt(kNeighbors);
                }
            }
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
            const requestData = {
                lat: selectedLat,
                lon: selectedLon,
                dataType: dataType,
                method: method,
                timeMode: timeMode,
                variables: variables,
                outputFormat: outputFormat,
                ...timeParams,
                ...meanParams
            };
            
            if (dataType === 'isobaric') {
                requestData.levels = levels;
            }
            
            // APIå‘¼ã³å‡ºã—
            fetch('/api/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                if (outputFormat === 'csv') {
                    // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `weather_data_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        showLoading(false);
                        showStatus('success', 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚');
                    });
                } else {
                    // JSONè¡¨ç¤º
                    return response.json();
                }
            })
            .then(data => {
                if (outputFormat === 'json' && data) {
                    showLoading(false);
                    showStatus('success', 'ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    displayResults(data);
                }
            })
            .catch(error => {
                console.error('æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                showLoading(false);
                showStatus('error', 'ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            });
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            console.log('Received data:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            if (data.error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ¤œè¨¼
            if (!data.data || !Array.isArray(data.data)) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼: data.data ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
                console.error('Invalid data structure:', data);
                return;
            }
            
            if (data.data.length === 0) {
                resultsDiv.innerHTML = `<div class="alert alert-warning">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>`;
                return;
            }
            
            // ä½¿ç”¨æ ¼å­ç‚¹ã‚’åœ°å›³ä¸Šã«è¡¨ç¤º
            if (data.metadata && data.metadata.used_grid_points) {
                showUsedGridPoints(data.metadata.used_grid_points);
            }
            
            // ã‚«ãƒ©ãƒ åã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æä¾›ã•ã‚Œã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã„å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨å®šï¼‰
            const columns = data.columns || Object.keys(data.data[0]);
            
            // ã‚«ãƒ©ãƒ åã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
            const columnMapping = {
                'time': 'æ™‚åˆ»',
                'lat': 'ç·¯åº¦',
                'lon': 'çµŒåº¦',
                'level_hPa': 'æ°—åœ§é¢ (hPa)',
                'method': 'æŠ½å‡ºæ–¹æ³•',
                'n_points': 'æ ¼å­ç‚¹æ•°',
                'u_ms': 'Uæˆåˆ† (m/s)',
                'v_ms': 'Væˆåˆ† (m/s)',
                'ta_C': 'æ°—æ¸© (Â°C)',
                'rh_%': 'ç›¸å¯¾æ¹¿åº¦ (%)',
                'ps_hPa': 'æµ·é¢æ›´æ­£æ°—åœ§ (hPa)',
                'pres_hPa': 'æ°—åœ§ (hPa)',
                'wind_speed_ms': 'é¢¨é€Ÿ (m/s)',
                'wind_direction_deg': 'é¢¨å‘ (åº¦)',
                'tas_C': 'åœ°ä¸Šæ°—æ¸© (Â°C)'
            };
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            let html = '<div class="results-table"><table class="table table-striped table-hover table-sm"><thead class="table-dark"><tr>';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥æœ¬èªåã‚’ä½¿ç”¨ï¼‰
            columns.forEach(col => {
                const displayName = columnMapping[col] || col;
                html += `<th>${displayName}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            data.data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    
                    // å€¤ã®è¡¨ç¤ºå½¢å¼ã‚’èª¿æ•´
                    if (typeof value === 'number') {
                        if (col.includes('time') || col === 'time') {
                            // æ™‚åˆ»ã¯ãã®ã¾ã¾è¡¨ç¤º
                            value = value;
                        } else if (col.includes('lat') || col.includes('lon')) {
                            // ç·¯åº¦çµŒåº¦ã¯å°æ•°ç‚¹4æ¡
                            value = value.toFixed(4);
                        } else if (col.includes('direction') || col.includes('deg')) {
                            // é¢¨å‘ã¯æ•´æ•°
                            value = Math.round(value);
                        } else {
                            // ãã®ä»–ã®æ•°å€¤ã¯å°æ•°ç‚¹2æ¡
                            value = value.toFixed(2);
                        }
                    } else if (value && typeof value === 'string' && value.includes('T')) {
                        // ISOæ™‚åˆ»æ–‡å­—åˆ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã«å¤‰æ›
                        try {
                            const date = new Date(value);
                            value = date.toLocaleString('ja-JP');
                        } catch (e) {
                            // å¤‰æ›å¤±æ•—æ™‚ã¯ãã®ã¾ã¾è¡¨ç¤º
                        }
                    }
                    
                    html += `<td>${value || '-'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            // ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚‚è¡¨ç¤º
            html = `<div class="mb-3">
                        <span class="badge bg-primary">${data.data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</span>
                        <span class="badge bg-info">${data.columns.length}åˆ—</span>
                    </div>` + html;
            
            resultsDiv.innerHTML = html;
            
            // ã‚°ãƒ©ãƒ•æç”»ï¼ˆJSONå½¢å¼ã®å ´åˆã®ã¿ï¼‰
            const outputFormat = document.getElementById('outputFormat').value;
            if (outputFormat === 'json') {
                drawCharts(data);
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = `extraction-status alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
            statusDiv.innerHTML = message;
            
            // 3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ä»¥å¤–ï¼‰
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const btn = document.getElementById('extractBtn');
            
            if (show) {
                loading.style.display = 'block';
                btn.disabled = true;
            } else {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        // ã‚°ãƒ©ãƒ•æç”»æ©Ÿèƒ½
        let currentCharts = []; // ç¾åœ¨ã®ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
        
        function drawCharts(data) {
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            currentCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            currentCharts = [];
            
            const chartsContainer = document.getElementById('charts-container');
            const chartsDiv = document.getElementById('charts');
            
            if (!data.data || data.data.length === 0) {
                chartsContainer.style.display = 'none';
                return;
            }
            
            // æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
            const hasTimeColumn = data.columns.includes('time');
            if (!hasTimeColumn) {
                chartsContainer.style.display = 'none';
                return;
            }
            
            // æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ©ãƒ ã‚’æŠ½å‡º
            const numericColumns = data.columns.filter(col => {
                return col !== 'time' && col !== 'lat' && col !== 'lon' && 
                       col !== 'method' && col !== 'level_hPa' && col !== 'n_points' &&
                       data.data.some(row => typeof row[col] === 'number');
            });
            
            if (numericColumns.length === 0) {
                chartsContainer.style.display = 'none';
                return;
            }
            
            // æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const timeLabels = data.data.map(row => {
                const timeValue = row.time;
                if (typeof timeValue === 'string' && timeValue.includes('T')) {
                    try {
                        const date = new Date(timeValue);
                        return date.toLocaleString('ja-JP', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return timeValue;
                    }
                }
                return timeValue;
            });
            
            // ã‚«ãƒ©ãƒ åã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
            const columnMapping = {
                'u_ms': 'Uæˆåˆ† (m/s)',
                'v_ms': 'Væˆåˆ† (m/s)',
                'ta_C': 'æ°—æ¸© (Â°C)',
                'tas_C': 'åœ°ä¸Šæ°—æ¸© (Â°C)',
                'rh_%': 'ç›¸å¯¾æ¹¿åº¦ (%)',
                'ps_hPa': 'æµ·é¢æ›´æ­£æ°—åœ§ (hPa)',
                'pres_hPa': 'æ°—åœ§ (hPa)',
                'wind_speed_ms': 'é¢¨é€Ÿ (m/s)',
                'wind_direction_deg': 'é¢¨å‘ (åº¦)'
            };
            
            // è‰²ã®ãƒ‘ãƒ¬ãƒƒãƒˆ
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            chartsDiv.innerHTML = '';
            
            // å„æ•°å€¤ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
            numericColumns.forEach((column, index) => {
                const chartData = data.data.map(row => row[column]);
                const displayName = columnMapping[column] || column;
                
                // ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'col-md-6 mb-4';
                chartWrapper.innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">${displayName}</div>
                        <canvas id="chart-${index}"></canvas>
                    </div>
                `;
                chartsDiv.appendChild(chartWrapper);
                
                // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
                const ctx = document.getElementById(`chart-${index}`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: displayName,
                            data: chartData,
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length] + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ™‚åˆ»'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: displayName
                                }
                            }
                        }
                    }
                });
                
                currentCharts.push(chart);
            });
            
            chartsContainer.style.display = 'block';
        }
        
        // ä½¿ç”¨æ ¼å­ç‚¹ã‚’åœ°å›³ä¸Šã«è¡¨ç¤º
        function showUsedGridPoints(gridPoints) {
            // æ—¢å­˜ã®ä½¿ç”¨æ ¼å­ç‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
            if (usedGridPointsLayer) {
                map.removeLayer(usedGridPointsLayer);
            }
            
            if (!gridPoints || gridPoints.length === 0) {
                return;
            }
            
            // æ–°ã—ã„æ ¼å­ç‚¹è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ã«ä½¿ç”¨ã•ã‚ŒãŸæ ¼å­ç‚¹ã‚’æ›´æ–°
            if (typeof window.updateUsedGridPoints === 'function') {
                window.updateUsedGridPoints(gridPoints);
                console.log('Updated used grid points via new system');
            }
            
            usedGridPointsLayer = L.layerGroup();
            
            gridPoints.forEach((point, index) => {
                // ä½¿ç”¨æ ¼å­ç‚¹ã‚’ç‰¹åˆ¥ãªè‰²ã§è¡¨ç¤ºï¼ˆå¾“æ¥ã®ã‚·ã‚¹ãƒ†ãƒ ï¼‰
                const circle = L.circleMarker([point.lat, point.lon], {
                    radius: 6,
                    color: 'purple',
                    fillColor: 'magenta',
                    fillOpacity: 0.8,
                    weight: 2
                }).bindPopup(`
                    <strong>ä½¿ç”¨æ ¼å­ç‚¹ #${index + 1}</strong><br>
                    ç·¯åº¦: ${point.lat.toFixed(4)}Â°<br>
                    çµŒåº¦: ${point.lon.toFixed(4)}Â°<br>
                    è·é›¢: ${point.distance.toFixed(1)} km<br>
                    ã‚°ãƒªãƒƒãƒ‰: [${point.grid_i}, ${point.grid_j}]<br>
                    æŠ½å‡ºæ–¹æ³•: ${point.method}
                `);
                
                usedGridPointsLayer.addLayer(circle);
            });
            
            usedGridPointsLayer.addTo(map);
            
            // æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const infoDiv = document.getElementById('grid-info') || document.createElement('div');
            infoDiv.id = 'grid-info';
            infoDiv.className = 'alert alert-info mt-2';
            infoDiv.innerHTML = `
                <strong>ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã§ä½¿ç”¨ã•ã‚ŒãŸæ ¼å­ç‚¹:</strong> ${gridPoints.length}ç‚¹<br>
                <small>ç´«è‰²ã®ç‚¹ãŒãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã«ä½¿ç”¨ã•ã‚ŒãŸæ ¼å­ç‚¹ã§ã™</small>
            `;
            
            const coordinatesDiv = document.getElementById('coordinates');
            if (coordinatesDiv.nextSibling && coordinatesDiv.nextSibling.id === 'grid-info') {
                coordinatesDiv.parentNode.replaceChild(infoDiv, coordinatesDiv.nextSibling);
            } else {
                coordinatesDiv.parentNode.insertBefore(infoDiv, coordinatesDiv.nextSibling);
            }
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initLevels();
            loadVariables();
            setupEventListeners();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»è¨­å®š
            const now = new Date();
            const defaultTime = '2024-07-03T12:00';
            document.getElementById('timeSingle').value = defaultTime;
            document.getElementById('timeStart').value = '2024-07-03T09:00';
            document.getElementById('timeEnd').value = '2024-07-03T15:00';
        });
    </script>
    
    <!-- æ ¼å­ç‚¹è¡¨ç¤ºæ©Ÿèƒ½ -->
    <script src="{{ url_for('static', filename='grid_display.js') }}" defer></script>
</body>
</html>